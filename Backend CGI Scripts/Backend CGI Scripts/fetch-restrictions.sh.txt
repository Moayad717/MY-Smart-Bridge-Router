#!/bin/sh

echo "Content-Type: application/json"
echo "Cache-Control: no-store"
echo ""

# Function to find hostname for a MAC address
get_hostname() {
    local mac="$1"
    # Try to get hostname from DHCP leases
    local hostname=$(grep -i "$mac" /tmp/dhcp.leases | cut -d' ' -f4)
    if [ -z "$hostname" ] || [ "$hostname" = "*" ]; then
        echo "$mac"
    else
        echo "$hostname"
    fi
}

# Start JSON output
echo "{"
echo "\"status\": \"success\","
echo "\"restrictions\": ["

# Get all time-based restriction rules
first=true
iptables -L FORWARD -n -v | grep "TIME" | while read line; do
    # Extract MAC address and time restrictions
    mac=$(echo "$line" | grep -o -E "MAC [0-9A-F:]{17}" | cut -d' ' -f2)
    if [ -n "$mac" ]; then
        start_time=$(echo "$line" | grep -o -E "timestart [0-9:]{8}" | cut -d' ' -f2)
        end_time=$(echo "$line" | grep -o -E "timestop [0-9:]{8}" | cut -d' ' -f2)

        # Get hostname for the MAC address
        hostname=$(get_hostname "$mac")

        # Add comma for all but first entry
        if [ "$first" = true ]; then
            first=false
        else
            echo ","
        fi

        # Output restriction entry
        echo "{"
        echo "\"mac\": \"$mac\","
        echo "\"hostname\": \"$hostname\","
        echo "\"start_time\": \"$start_time\","
        echo "\"end_time\": \"$end_time\""
        echo -n "}"
    fi
done

# Close JSON structure
echo "]"
echo "}"