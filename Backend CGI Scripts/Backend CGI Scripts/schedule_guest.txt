#!/bin/sh

echo "Content-Type: application/json"
echo "Access-Control-Allow-Origin: *"
echo ""

# Read JSON input
read -r input

# Extract action from JSON
action=$(echo "$input" | jsonfilter -e '@.action')

case "$action" in
    "schedule")
        # Get start and end times
        start_time=$(echo "$input" | jsonfilter -e '@.start_time')
        end_time=$(echo "$input" | jsonfilter -e '@.end_time')

        # Remove existing schedule entries
        sed -i '/guest_network/d' /etc/crontabs/root

        # Add new schedule entries with full paths
        echo "$start_time /usr/bin/guest_network enable" >> /etc/crontabs/root
        echo "$end_time /usr/bin/guest_network disable" >> /etc/crontabs/root

        # Restart cron to apply changes
        /etc/init.d/cron restart

        logger "Guest network schedule updated: enable at $start_time, disable at $end_time"
        echo '{"status":"success","message":"Schedule updated"}'
        ;;

    "clear")
        # Remove schedule entries
        sed -i '/guest_network/d' /etc/crontabs/root

        # Restart cron to apply changes
        /etc/init.d/cron restart

        logger "Guest network schedule cleared"
        echo '{"status":"success","message":"Schedule cleared"}'
        ;;

    *)
        echo '{"status":"error","message":"Invalid action"}'
        ;;
esac