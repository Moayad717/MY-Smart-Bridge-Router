#!/bin/sh

# Print HTTP headers
echo "Content-type: application/json"
echo "Access-Control-Allow-Origin: *"
echo "Access-Control-Allow-Methods: GET, POST, OPTIONS"
echo "Access-Control-Allow-Headers: Content-Type"
echo ""

# Check if running from a web request (QUERY_STRING)
if [ -n "$QUERY_STRING" ]; then
    # Convert '&' to newlines, then parse variables
    eval $(echo "$QUERY_STRING" | sed 's/&/\n/g' | sed 's/\([^=]*\)=\([^=]*\)/\1="\2"/')
fi

# Validate inputs
if [ -z "$mac" ] || [ -z "$site" ]; then
    echo '{"status": "error", "message": "MAC address and site are required"}'
    exit 1
fi

# Convert site name to match firewall rule format
formatted_site=$(echo "$site" | sed 's/\./_/g')
rule_name="Parental_${mac}_${formatted_site}"

# Check if the rule exists
existing_rule=$(uci show firewall | grep "name='$rule_name'" | cut -d. -f2)

if [ -z "$existing_rule" ]; then
    echo '{"status": "error", "message": "No rule found for MAC: '"$mac"' and Site: '"$site"'"}'
    exit 1
fi

# Delete the firewall rule
uci delete firewall.$existing_rule
uci commit firewall
/etc/init.d/firewall reload

echo '{"status": "success", "message": "Deleted rule for MAC: '"$mac"', Site: '"$site"'"}'
