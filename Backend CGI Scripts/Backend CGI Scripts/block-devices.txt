#!/bin/sh

# Set content type header
echo "Content-type: text/plain"
echo ""

# Read MAC address from query string
MAC_ADDRESS=$(echo "$QUERY_STRING" | tr '-' ':')

# Validate MAC address format
if ! echo "$MAC_ADDRESS" | grep -Eq '^([0-9A-Fa-f]{2}[:]){5}([0-9A-Fa-f]{2})$'; then
    echo "Error: Invalid MAC address format"
    exit 1
fi

echo "Blocking device with MAC: $MAC_ADDRESS..."

# Try to add firewall rule
if ! uci add firewall rule; then
    echo "Error: Failed to add firewall rule"
    exit 1
fi

# Configure firewall rule
uci set firewall.@rule[-1].name="Block_$MAC_ADDRESS"
uci set firewall.@rule[-1].src="lan"
uci set firewall.@rule[-1].dest="*"
uci set firewall.@rule[-1].proto="all"
uci set firewall.@rule[-1].src_mac="$MAC_ADDRESS"
uci set firewall.@rule[-1].target="REJECT"

# Commit changes
if ! uci commit firewall; then
    echo "Error: Failed to commit firewall changes"
    exit 1
fi

# Restart firewall
if ! /etc/init.d/firewall restart; then
    echo "Error: Failed to restart firewall"
    exit 1
fi

echo "Device $MAC_ADDRESS has been blocked successfully!"
exit 0