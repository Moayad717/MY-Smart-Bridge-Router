#!/bin/sh

# Print HTTP headers
echo "Content-type: application/json"
echo "Access-Control-Allow-Origin: *"
echo "Access-Control-Allow-Methods: GET, POST, OPTIONS"
echo "Access-Control-Allow-Headers: Content-Type"
echo ""

# Fetch firewall rules related to time restrictions
rules=$(uci show firewall | grep "name='Time_Restrict_" | cut -d. -f2)

# Start JSON response
echo "{\"rules\": ["

first=true
for rule in $rules; do
    # Fetch MAC, start time, and end time
    mac=$(uci get firewall.$rule.src_mac 2>/dev/null)
    start_time=$(uci get firewall.$rule.start_time 2>/dev/null)
    end_time=$(uci get firewall.$rule.stop_time 2>/dev/null)

    # Skip if any value is missing
    if [ -z "$mac" ] || [ -z "$start_time" ] || [ -z "$end_time" ]; then
        continue
    fi

    # Add comma if not the first rule
    if [ "$first" = false ]; then
        echo ","
    fi
    first=false

    # Print rule as JSON object
    echo "    {\"mac\": \"$mac\", \"start_time\": \"$start_time\", \"end_time\": \"$end_time\"}"
done

echo "]}"
