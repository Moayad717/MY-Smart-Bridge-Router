#!/bin/sh

echo "Content-type: text/plain"
echo ""

# Define API endpoints and credentials
STATS_URL="http://70.70.70.1:8080/control/stats"
QUERYLOG_URL="http://70.70.70.1:8080/control/querylog"
USERNAME="Senior_adBlock"
PASSWORD="adblock700800900"

# Fetch statistics
STATS=$(curl -s -u "$USERNAME:$PASSWORD" "$STATS_URL")

# Extract relevant statistics
TOTAL_QUERIES=$(echo "$STATS" | grep -o '"num_dns_queries":[0-9]*' | cut -d':' -f2)
BLOCKED_QUERIES=$(echo "$STATS" | grep -o '"num_blocked_filtering":[0-9]*' | cut -d':' -f2)
ADULT_BLOCKED=$(echo "$STATS" | grep -o '"num_replaced_parental":[0-9]*' | cut -d':' -f2)

# Calculate percentage if total queries is not zero
if [ "$TOTAL_QUERIES" -ne 0 ]; then
    BLOCKED_PERCENTAGE=$(awk "BEGIN {printf \"%.2f\", ($BLOCKED_QUERIES / $TOTAL_QUERIES) * 100}")
else
    BLOCKED_PERCENTAGE="0.00"
fi

# Output statistics
echo "total_queries=$TOTAL_QUERIES"
echo "blocked_queries=$BLOCKED_QUERIES"
echo "adult_blocked=$ADULT_BLOCKED"
echo "blocked_percentage=$BLOCKED_PERCENTAGE"

# Fetch recent queries (last 100)
echo "--- recent_queries ---"
QUERYLOG=$(curl -s -u "$USERNAME:$PASSWORD" "$QUERYLOG_URL?limit=100")

# Extract and display each query in a simple format
echo "$QUERYLOG" | grep -o '"question":{[^}]*}' | while read -r QUESTION; do
    DOMAIN=$(echo "$QUESTION" | grep -o '"name":"[^"]*' | cut -d'"' -f4)
    TYPE=$(echo "$QUESTION" | grep -o '"type":"[^"]*' | cut -d'"' -f4)
    echo "$DOMAIN ($TYPE)"
done