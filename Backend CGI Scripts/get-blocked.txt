#!/bin/sh

echo "Content-type: text/html"
echo ""

cat << EOF
<!DOCTYPE html>
<html>
<head>
    <title>OpenWrt Blocked Devices</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        tr:nth-child(even) { background-color: #f9f9f9; }
    </style>
</head>
<body>
    <h1>Blocked Devices on OpenWrt Router</h1>
    <table>
        <tr>
            <th>Rule Name</th>
            <th>MAC Address</th>
            <th>Blocking Status</th>
        </tr>
EOF

# Get all firewall rules
blocked_devices=$(uci show firewall | grep "@rule" | grep "Block_" | grep "name=" | sed -e 's/^.*name=//g' -e 's/^.\(.*\)./\1/g')

# Process each rule
for rule in $blocked_devices; do
    # Extract MAC address from rule name (format: Block_XX:XX:XX:XX:XX:XX)
    mac_address=$(echo "$rule" | sed -e 's/Block_//g')

    # Get the rule number to check if it's enabled
    rule_number=$(uci show firewall | grep "name='$rule'" | grep -o "@rule\[[0-9]*\]" | sed -e 's/@rule\[\(.*\)\]/\1/g')

    # Check if the rule is enabled (not disabled)
    is_disabled=$(uci get firewall.@rule["$rule_number"].enabled 2>/dev/null)

    if [ "$is_disabled" = "0" ]; then
        status="Disabled"
    else
        status="Active"
    fi

    # Output table row
    echo "        <tr>"
    echo "            <td>$rule</td>"
    echo "            <td>$mac_address</td>"
    echo "            <td>$status</td>"
    echo "        </tr>"
done

cat << EOF
    </table>
    <p><small>Last updated: $(date)</small></p>
</body>
</html>
EOF