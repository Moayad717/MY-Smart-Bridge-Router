#!/bin/sh

# Enable debugging
set -e

# Parse query string correctly
QUERY_STRING=$(echo "$QUERY_STRING" | sed 's/%20/ /g' | sed 's/+/ /g')

SSID=$(echo "$QUERY_STRING" | awk -F '&' '{for (i=1; i<=NF; i++) { if ($i ~ /^ssid=/) { sub(/^ssid=/, "", $i); print $i } }}')
PASSWORD=$(echo "$QUERY_STRING" | awk -F '&' '{for (i=1; i<=NF; i++) { if ($i ~ /^password=/) { sub(/^password=/, "", $i); print $i } }}')

# Ensure decoding of special characters
SSID=$(printf '%b' "${SSID//%/\\x}")
PASSWORD=$(printf '%b' "${PASSWORD//%/\\x}")

# Debugging Output
echo "Content-type: text/plain"
echo ""
echo "Debug: Received SSID='$SSID', PASSWORD='$PASSWORD'" >> /tmp/wifi_debug.log

if [ -z "$SSID" ]; then
    echo "Error: SSID is required"
    exit 1
fi

if [ -z "$PASSWORD" ]; then
    ENCRYPTION_TYPE="none"
    PASSWORD_LINE=""
else
    ENCRYPTION_TYPE="psk2"
    PASSWORD_LINE="option key '$PASSWORD'"
fi

# Update the wireless configuration
uci set wireless.wifinet3.ssid="$SSID"
uci set wireless.wifinet3.encryption="$ENCRYPTION_TYPE"
uci delete wireless.wifinet3.key 2>/dev/null || true

if [ "$ENCRYPTION_TYPE" != "none" ]; then
    uci set wireless.wifinet3.key="$PASSWORD"
fi

uci commit wireless

# Restart the network to apply changes
wifi reload
/etc/init.d/network restart
# Output success message
echo "Successfully connected to $SSID"
